<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#createToken">createToken</a></li><li><a href="global.html#refreshToken">refreshToken</a></li><li><a href="global.html#verifyToken">verifyToken</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const jwt = require("jsonwebtoken");
const { reject } = require("lodash");

const {
  algorithm,
  secretKey,
  expiresTime,
  refreshTime,
} = require("./config.local.js");
/**
 * @description 创建 Token
 * @param { Object } data 用于加密的数据
 * @param { String } time token 有效期
 * @return {String} Token 成功返回token，失败返回 ""
 */
function createToken(data, time) {
  let token = jwt.sign(data, secretKey, {
    expiresIn: time || expiresTime,
  });
  return token || "";
}

/**
 * @description 验证 token Promise风格
 * @param {String} token
 * @return {Promise} 验证结果
 * @example
 * await verifyToken(token)
 * =>
 * Promise.reslove({
 *  code:0,
 *  msg:"token-valid",
 *  data: Payload + iat + exp
 * })
 */
async function verifyToken(token) {
  return new Promise((reslove, reject) => {
    jwt.verify(token, secretKey, function (err, decoded) {
      if (err) {
        reject({
          code: 1,
          msg: {
            errorName: err.name,
            errorMessage: err.message,
          },
          data: null,
        });
      } else {
        reslove({
          code: 0,
          msg: "token-valid",
          data: decoded,
        });
      }
    });
  });
}
/**
 * @description 自动刷新 token
 * @param {Object} data token的Payload
 * @return { String |null} 成功返回Token,失败返回null
 * @example
 * refreshToken({username:XXX,password:XXXX})
 * =>
 * token | 空串
 */
function refreshToken(data) {
  const { iat, exp, ...payLoadData } = data; // iat 签发时间 exp 过期时间
  const nowTmp = Math.floor(Date.now() / 1000); // 当前时间戳
  const leftSecond = exp - nowTmp;
  console.log("剩余秒数", leftSecond, typeof leftSecond);
  if (leftSecond >= 0 &amp;&amp; leftSecond &lt;= refreshTime) {
    const newToken = createToken(payLoadData);
    return newToken;
  } else {
    return null;
  }
}

module.exports = {
  createToken,
  verifyToken,
  refreshToken,
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Sun Mar 19 2023 19:38:27 GMT+0800 (中国标准时间) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
